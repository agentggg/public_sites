import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { View, Text, TextInput, Button, StyleSheet, Alert, ScrollView } from 'react-native';

const BACKEND = 'https://your-backend-url.com'; // replace with your actual backend URL

const HomePage = () => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [token, setToken] = useState(null);
  const [user, setUser] = useState(null);
  const [tenantData, setTenantData] = useState({ leases: [], payments: [], maintenance: [] });
  const [role, setRole] = useState('');

  const login = async () => {
    try {
      const res = await axios.post(`${BACKEND}/api/token/`, { username, password });
      setToken(res.data.token);
    } catch (error) {
      Alert.alert('Login Failed', 'Please check your credentials.');
    }
  };

  useEffect(() => {
    const fetchUserData = async () => {
      if (!token) return;

      try {
        const res = await axios.get(`${BACKEND}/api/me/`, {
          headers: { Authorization: `Token ${token}` },
        });
        setUser(res.data);
        setRole(res.data.role);

        if (res.data.role === 'tenant') {
          const [leases, payments, maintenance] = await Promise.all([
            axios.get(`${BACKEND}/api/leases/?tenant=${res.data.id}`, { headers: { Authorization: `Token ${token}` } }),
            axios.get(`${BACKEND}/api/payments/?tenant=${res.data.id}`, { headers: { Authorization: `Token ${token}` } }),
            axios.get(`${BACKEND}/api/maintenance/?tenant=${res.data.id}`, { headers: { Authorization: `Token ${token}` } }),
          ]);

          setTenantData({
            leases: leases.data,
            payments: payments.data,
            maintenance: maintenance.data,
          });
        }
      } catch (error) {
        Alert.alert('Error', 'Failed to fetch user data.');
      }
    };

    fetchUserData();
  }, [token]);

  if (!token) {
    return (
      <View style={styles.container}>
        <Text style={styles.title}>Login</Text>
        <TextInput placeholder="Username" value={username} onChangeText={setUsername} style={styles.input} />
        <TextInput placeholder="Password" value={password} onChangeText={setPassword} secureTextEntry style={styles.input} />
        <Button title="Login" onPress={login} />
      </View>
    );
  }

  return (
    <ScrollView style={styles.container}>
      <Text style={styles.title}>Welcome, {user?.first_name}</Text>
      {role === 'manager' ? (
        <>
          <Button title="Manage Tenants" onPress={() => {/* navigation logic */}} />
          <Button title="View All Leases" onPress={() => {/* navigation logic */}} />
          <Button title="View All Payments" onPress={() => {/* navigation logic */}} />
          <Button title="Maintenance Requests" onPress={() => {/* navigation logic */}} />
        </>
      ) : (
        <>
          <Text style={styles.sectionTitle}>My Leases</Text>
          {tenantData.leases.map((lease, i) => (
            <Text key={i}>{lease.unit}</Text>
          ))}

          <Text style={styles.sectionTitle}>My Payments</Text>
          {tenantData.payments.map((pay, i) => (
            <Text key={i}>{pay.amount} - {pay.payment_date}</Text>
          ))}

          <Text style={styles.sectionTitle}>My Maintenance Requests</Text>
          {tenantData.maintenance.map((req, i) => (
            <Text key={i}>{req.issue_description} - {req.status}</Text>
          ))}
        </>
      )}
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    padding: 20,
    backgroundColor: '#fff',
    flex: 1,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    marginBottom: 20,
  },
  input: {
    borderWidth: 1,
    padding: 10,
    marginBottom: 10,
    borderRadius: 5,
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: '600',
    marginTop: 20,
  },
});

export default HomePage;
