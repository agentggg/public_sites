<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Code Study Viewer</title>

  <!-- Prism -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css">

  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --border: rgba(255,255,255,0.12);
      --accent: #ea5a28;
      --danger: #ff4d4d;
      --shadow: 0 12px 40px rgba(0,0,0,0.55);
      --radius: 16px;
      --radius2: 20px;
      --codeFont: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --uiFont: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--uiFont);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(234,90,40,0.25), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(0,170,255,0.15), transparent 55%),
        linear-gradient(180deg, #070a10, var(--bg));
      color: var(--text);
      overflow-x: hidden;
    }

    .app { max-width: 1160px; margin: 0 auto; padding: 14px 12px 40px; }

    .topbar {
      position: sticky; top: 0; z-index: 80;
      padding: 12px 0 10px;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(11,15,23,0.95), rgba(11,15,23,0.55));
      border-bottom: 1px solid var(--border);
    }

    .headerRow { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    h1 { margin:0; font-size: 18px; line-height:1.2; }
    .sub { margin-top:4px; font-size:12px; color: var(--muted); line-height:1.25; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border: 1px solid var(--border);
      background: var(--panel); border-radius: 999px;
      font-size: 12px; color: var(--muted); white-space: nowrap;
    }

    .controls {
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (min-width: 920px) {
      .controls { grid-template-columns: 1.35fr 1.35fr 1fr 1fr; }
    }

    .field {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .labelRow { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
    label { font-size: 12px; color: var(--muted); }

    select, input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      min-height: 44px;
    }
    select:focus, input[type="text"]:focus { border-color: rgba(234,90,40,0.55); }

    .toolbar {
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (min-width: 920px) { .toolbar { grid-template-columns: 1fr 1fr 1fr 1fr; } }

    .btn {
      min-height: 46px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      padding: 12px 12px;
      display:flex; align-items:center; justify-content:center; gap:8px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.08s ease, background 0.12s ease, border-color 0.12s ease;
    }
    .btn:active { transform: scale(0.99); }
    .btn:hover { background: var(--panel2); }
    .btn.primary { border-color: rgba(234,90,40,0.45); background: rgba(234,90,40,0.12); }
    .btn.danger { border-color: rgba(255,77,77,0.35); background: rgba(255,77,77,0.10); }

    /* Layout: code + toc on desktop */
    .mainGrid{
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (min-width: 920px){
      .mainGrid{
        grid-template-columns: 1fr 320px;
      }
    }

    .content { display:grid; grid-template-columns: 1fr; gap: 12px; }

    .card {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: var(--radius2);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .cardHead {
      padding: 12px 12px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    }

    .meta { display:flex; flex-direction:column; gap:4px; min-width:0; }
    .title { font-size:14px; font-weight:700; line-height:1.2; word-break: break-word; }
    .badges { display:flex; flex-wrap:wrap; gap:6px; margin-top:2px; }
    .badge {
      font-size: 11px;
      color: rgba(255,255,255,0.82);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.20);
      padding: 6px 8px;
      border-radius: 999px;
    }
    .badge.accent { border-color: rgba(234,90,40,0.4); background: rgba(234,90,40,0.11); }

    .cardActions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .smallBtn {
      min-height: 38px;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      cursor: pointer;
    }
    .smallBtn:hover { background: rgba(255,255,255,0.08); }

    pre[class*="language-"] {
      margin: 0;
      padding: 14px 12px 14px 52px !important;
      border-radius: 0;
      font-family: var(--codeFont) !important;
      font-size: var(--codeSize, 13px);
      line-height: 1.45;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 920px) { pre[class*="language-"] { padding: 16px 14px 16px 56px !important; } }

    .wrap pre[class*="language-"] {
      white-space: pre-wrap !important;
      word-break: break-word;
      overflow-x: hidden;
    }

    .hintRow{
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      background: rgba(255,255,255,0.03);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap: wrap;
    }

    .notes {
      padding: 12px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      display:none;
    }
    .notes.open { display:block; }
    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      border-radius: 14px;
      padding: 12px;
      font-size: 14px;
      line-height: 1.35;
      outline: none;
    }
    textarea:focus { border-color: rgba(234,90,40,0.55); }

    .empty {
      padding: 18px 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: var(--radius2);
      background: rgba(0,0,0,0.15);
      color: var(--muted);
      line-height: 1.35;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.72);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 1000;
      max-width: calc(100% - 24px);
    }
    .toast.show { opacity:1; transform: translateX(-50%) translateY(-4px); }

    mark { background: rgba(234,90,40,0.35); color: var(--text); padding: 0 2px; border-radius: 3px; }

    /* TOC */
    .tocCard{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: sticky;
      top: 160px; /* below topbar */
      max-height: calc(100vh - 190px);
      display: none;
    }
    @media (min-width: 920px){
      .tocCard{ display:block; }
    }
    .tocHead{
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .tocTitle{
      font-weight: 800;
      font-size: 13px;
    }
    .tocBody{
      padding: 10px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(100vh - 240px);
    }
    .tocItem{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      width: 100%;
      text-align: left;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      cursor: pointer;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .tocItem:hover{ background: rgba(255,255,255,0.08); }
    .tocLeft{
      min-width:0;
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .tocName{
      font-weight: 750;
      line-height: 1.15;
      word-break: break-word;
    }
    .tocKind{
      font-size: 11px;
      color: var(--muted);
    }
    .tocLine{
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Mobile TOC bottom drawer */
    .tocFab{
      position: fixed;
      right: 12px;
      bottom: 18px;
      z-index: 120;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 50px;
      min-width: 120px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(234,90,40,0.45);
      background: rgba(234,90,40,0.14);
      color: var(--text);
      font-weight: 800;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    @media (min-width: 920px){
      .tocFab{ display:none; }
    }

    .drawerOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      z-index: 150;
      display: none;
    }
    .drawer{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      max-height: 72vh;
      background: rgba(16,20,30,0.92);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      z-index: 160;
      display: none;
      overflow: hidden;
    }
    .drawer.open, .drawerOverlay.open { display:block; }
    .drawerHead{
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    }
    .drawerBody{
      padding: 10px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* line pulse (we scroll to it + animate the line background) */
    .linePulse{
      animation: pulse 1.1s ease-out 1;
    }
    @keyframes pulse{
      0%{ background: rgba(234,90,40,0.0); }
      20%{ background: rgba(234,90,40,0.24); }
      100%{ background: rgba(234,90,40,0.0); }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="app">
      <div class="headerRow">
        <div>
          <h1>Code Study Viewer</h1>
          <div class="sub">Pick a file from <b>/code</b>. Files are named <b>language_projectname.json</b> and contain pure code text.</div>
        </div>
        <div class="pill" id="statusPill">Loading file list…</div>
      </div>

      <div class="controls">
        <div class="field">
          <div class="labelRow">
            <label for="fileSelect">Code file</label>
            <span style="font-size:12px;color:var(--muted)" id="fileCount">0</span>
          </div>
          <select id="fileSelect">
            <option value="">Loading…</option>
          </select>
        </div>

        <div class="field">
          <div class="labelRow">
            <label for="projectSelect">Project filter</label>
            <span style="font-size:12px;color:var(--muted)" id="projectCount">0</span>
          </div>
          <select id="projectSelect">
            <option value="">All Projects</option>
          </select>
        </div>

        <div class="field">
          <div class="labelRow">
            <label for="languageSelect">Language filter</label>
            <span style="font-size:12px;color:var(--muted)" id="languageCount">0</span>
          </div>
          <select id="languageSelect">
            <option value="">All Languages</option>
          </select>
        </div>

        <div class="field">
          <div class="labelRow">
            <label for="searchInput">Search (highlights matches)</label>
            <span style="font-size:12px;color:var(--muted)" id="matchCount">0</span>
          </div>
          <input id="searchInput" type="text" placeholder="Search inside code…" />
        </div>
      </div>

      <div class="toolbar">
        <button class="btn primary" id="wrapBtn" type="button">Wrap: ON</button>
        <button class="btn" id="fontMinusBtn" type="button">A−</button>
        <button class="btn" id="fontPlusBtn" type="button">A+</button>
        <button class="btn" id="clearNotesBtn" type="button">Clear all notes</button>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="mainGrid">
      <div>
        <div id="list" class="content"></div>
        <div id="empty" class="empty" style="display:none;"></div>
      </div>

      <!-- Desktop TOC -->
      <aside class="tocCard" id="tocCard">
        <div class="tocHead">
          <div>
            <div class="tocTitle">Table of Contents</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;" id="tocMeta">No file</div>
          </div>
          <button class="smallBtn" id="tocRefreshBtn" type="button">Refresh</button>
        </div>
        <div class="tocBody" id="tocBody"></div>
      </aside>
    </div>
  </div>

  <!-- Mobile TOC -->
  <button class="tocFab" id="tocFab" type="button">TOC</button>
  <div class="drawerOverlay" id="drawerOverlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div style="font-weight:900;">Table of Contents</div>
      <button class="smallBtn" id="drawerCloseBtn" type="button">Close</button>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Prism -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

  <!-- Common languages -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-go.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-csharp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>

  <script>
    // ----------------------------
    // Config
    // ----------------------------
    const CODE_DIR = "code";
    const MANIFEST = `${CODE_DIR}/index.json`;

    // ----------------------------
    // State
    // ----------------------------
    let FILES = [];
    let SNIPPETS = []; // 1 snippet per loaded file
    let wrapOn = true;
    let codeSize = 13;

    // TOC items for current snippet
    let TOC = [];

    const els = {
      fileSelect: document.getElementById("fileSelect"),
      fileCount: document.getElementById("fileCount"),
      projectSelect: document.getElementById("projectSelect"),
      languageSelect: document.getElementById("languageSelect"),
      searchInput: document.getElementById("searchInput"),

      list: document.getElementById("list"),
      empty: document.getElementById("empty"),
      statusPill: document.getElementById("statusPill"),

      projectCount: document.getElementById("projectCount"),
      languageCount: document.getElementById("languageCount"),
      matchCount: document.getElementById("matchCount"),

      wrapBtn: document.getElementById("wrapBtn"),
      fontMinusBtn: document.getElementById("fontMinusBtn"),
      fontPlusBtn: document.getElementById("fontPlusBtn"),
      clearNotesBtn: document.getElementById("clearNotesBtn"),

      toast: document.getElementById("toast"),

      tocCard: document.getElementById("tocCard"),
      tocMeta: document.getElementById("tocMeta"),
      tocBody: document.getElementById("tocBody"),
      tocRefreshBtn: document.getElementById("tocRefreshBtn"),

      tocFab: document.getElementById("tocFab"),
      drawer: document.getElementById("drawer"),
      drawerOverlay: document.getElementById("drawerOverlay"),
      drawerCloseBtn: document.getElementById("drawerCloseBtn"),
      drawerBody: document.getElementById("drawerBody"),
    };

    function toast(msg) {
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      setTimeout(() => els.toast.classList.remove("show"), 1400);
    }

    function safeString(v) {
      if (v === null || v === undefined) return "";
      return String(v);
    }

    function escapeHtml(s) {
      return safeString(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeLanguage(lang) {
      const l = safeString(lang).trim().toLowerCase();
      if (!l) return "plaintext";
      const map = {
        "py": "python",
        "python3": "python",
        "js": "javascript",
        "node": "javascript",
        "ts": "typescript",
        "md": "markdown",
        "shell": "bash",
        "sh": "bash",
        "yml": "yaml",
        "golang": "go",
        "c#": "csharp",
      };
      return map[l] || l;
    }

    function parseFilename(filename) {
      const base = filename.split("/").pop();
      const noExt = base.replace(/\.json$/i, "");
      const parts = noExt.split("_");
      const language = normalizeLanguage(parts[0] || "");
      const projectname = parts.slice(1).join("_") || "(No project)";
      return { language, projectname, filename: base };
    }

    function injectSearchMarks(code, query) {
      const q = safeString(query).trim();
      if (!q) return escapeHtml(code);
      const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "gi");
      const escaped = escapeHtml(code);
      return escaped.replace(re, (m) => `<mark>${m}</mark>`);
    }

    function snippetKey(snippet) {
      const hashBase = `${snippet.filename}::${snippet.language}::${snippet.projectname}::${snippet.code.length}`;
      return "note:" + btoa(unescape(encodeURIComponent(hashBase))).slice(0, 44);
    }

    function getSavedNote(key) { return localStorage.getItem(key) || ""; }
    function setSavedNote(key, val) { localStorage.setItem(key, val); }

    function clearAllNotes() {
      const prefix = "note:";
      const keys = [];
      for (let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if (k && k.startsWith(prefix)) keys.push(k);
      }
      keys.forEach(k => localStorage.removeItem(k));
    }

    async function copyToClipboard(text) {
      if (navigator.clipboard) return navigator.clipboard.writeText(text);
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }

    function computeFiltersFromSnippets() {
      const projects = new Set();
      const langs = new Set();
      SNIPPETS.forEach(s => {
        projects.add(s.projectname);
        langs.add(s.language);
      });

      const projectArr = Array.from(projects).sort((a,b)=>a.localeCompare(b));
      els.projectSelect.innerHTML =
        `<option value="">All Projects</option>` +
        projectArr.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
      els.projectCount.textContent = projectArr.length;

      const langArr = Array.from(langs).sort((a,b)=>a.localeCompare(b));
      els.languageSelect.innerHTML =
        `<option value="">All Languages</option>` +
        langArr.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
      els.languageCount.textContent = langArr.length;
    }

    function getFilters() {
      return { project: els.projectSelect.value, lang: els.languageSelect.value, q: els.searchInput.value };
    }

    // ----------------------------
    // TOC extraction
    // ----------------------------
    function extractTOC(codeText, languageHint) {
      const lines = codeText.replace(/\r\n/g, "\n").split("\n");
      const out = [];

      // regexes that catch common definitions
      const rules = [
        { kind: "class", re: /^\s*class\s+([A-Za-z_]\w*)/ },
        { kind: "def", re: /^\s*def\s+([A-Za-z_]\w*)\s*\(/ },
        { kind: "function", re: /^\s*(?:export\s+)?function\s+([A-Za-z_]\w*)\s*\(/ },
        { kind: "const", re: /^\s*(?:export\s+)?const\s+([A-Za-z_]\w*)\s*=/ },
        { kind: "let", re: /^\s*let\s+([A-Za-z_]\w*)\s*=/ },
        { kind: "var", re: /^\s*var\s+([A-Za-z_]\w*)\s*=/ },
        { kind: "interface", re: /^\s*interface\s+([A-Za-z_]\w*)/ },
        { kind: "type", re: /^\s*type\s+([A-Za-z_]\w*)\s*=/ },
        { kind: "struct", re: /^\s*struct\s+([A-Za-z_]\w*)/ },
        // SQL-ish anchors
        { kind: "sql", re: /^\s*(SELECT|WITH|CREATE|ALTER|INSERT|UPDATE|DELETE)\b/i, captureIndex: 1 },
      ];

      // If the file is huge, keep TOC reasonable (still fast on mobile)
      const MAX_ITEMS = 240;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Skip empty/comment-only lines quickly
        const trimmed = line.trim();
        if (!trimmed) continue;

        for (const rule of rules) {
          const m = line.match(rule.re);
          if (!m) continue;

          const name = m[rule.captureIndex || 1] || trimmed.slice(0, 60);
          // "SELECT" etc. use the keyword as name
          const displayName = rule.kind === "sql" ? `${name.toUpperCase()} …` : name;

          out.push({
            kind: rule.kind,
            name: displayName,
            line: i + 1,
            preview: trimmed.slice(0, 120),
          });

          if (out.length >= MAX_ITEMS) return out;
          break;
        }
      }

      // As a fallback, if nothing was found, add some "anchors" every N lines
      if (!out.length) {
        const step = Math.max(40, Math.floor(lines.length / 12));
        for (let i = 0; i < lines.length; i += step) {
          out.push({ kind: "section", name: `Line ${i+1}`, line: i+1, preview: (lines[i] || "").trim().slice(0,120) });
        }
      }

      return out;
    }

    function renderTOC() {
      const current = SNIPPETS[0];
      if (!current) {
        els.tocMeta.textContent = "No file";
        els.tocBody.innerHTML = `<div style="color:var(--muted);padding:10px;">Load a file to see TOC.</div>`;
        els.drawerBody.innerHTML = els.tocBody.innerHTML;
        return;
      }

      TOC = extractTOC(current.code, current.language);
      els.tocMeta.textContent = `${TOC.length} items • ${current.filename}`;

      const html = TOC.map((t, idx) => `
        <button class="tocItem" data-toc-idx="${idx}" type="button" title="${escapeHtml(t.preview)}">
          <div class="tocLeft">
            <div class="tocName">${escapeHtml(t.name)}</div>
            <div class="tocKind">${escapeHtml(t.kind)}</div>
          </div>
          <div class="tocLine">L${t.line}</div>
        </button>
      `).join("");

      const emptyHtml = `<div style="color:var(--muted);padding:10px;">No symbols found.</div>`;
      els.tocBody.innerHTML = html || emptyHtml;
      els.drawerBody.innerHTML = html || emptyHtml;
    }

    function openDrawer() {
      els.drawerOverlay.classList.add("open");
      els.drawer.classList.add("open");
    }
    function closeDrawer() {
      els.drawerOverlay.classList.remove("open");
      els.drawer.classList.remove("open");
    }

    function scrollToLine(lineNumber) {
      const pre = document.querySelector("pre.line-numbers");
      if (!pre) return;

      // Prism line numbers plugin inserts: <span class="line-numbers-rows"><span></span>...</span>
      const rows = pre.querySelector(".line-numbers-rows");
      if (!rows) return;

      const lineEl = rows.children[lineNumber - 1];
      if (!lineEl) return;

      // Scroll the PRE container so that line is visible
      const preRect = pre.getBoundingClientRect();
      const lineRect = lineEl.getBoundingClientRect();

      const delta = (lineRect.top - preRect.top) - (pre.clientHeight * 0.25);
      pre.scrollTop += delta;

      // Visual pulse: apply to code line by approximating via scrollTop; also pulse line number span
      lineEl.classList.remove("linePulse");
      void lineEl.offsetWidth;
      lineEl.classList.add("linePulse");

      toast(`Jumped to line ${lineNumber}`);
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function render() {
      if (!SNIPPETS.length) {
        els.list.innerHTML = "";
        els.empty.style.display = "block";
        els.empty.innerHTML = `
          <div style="font-weight:700;color:rgba(255,255,255,0.9);margin-bottom:6px;">No file loaded</div>
          <div>
            Put your code files in <b>/code</b> and list them in <b>/code/index.json</b>.
            Then pick a file from the dropdown.
          </div>
        `;
        els.matchCount.textContent = "0";
        renderTOC();
        return;
      }

      const { project, lang, q } = getFilters();

      const filtered = SNIPPETS.filter(s => {
        if (project && s.projectname !== project) return false;
        if (lang && s.language !== lang) return false;
        return true;
      });

      if (!filtered.length) {
        els.list.innerHTML = "";
        els.empty.style.display = "block";
        els.empty.innerHTML = `
          <div style="font-weight:700;color:rgba(255,255,255,0.9);margin-bottom:6px;">No results</div>
          <div>Change filters or clear search.</div>
        `;
        els.statusPill.textContent = `0 / ${SNIPPETS.length} shown`;
        els.matchCount.textContent = "0";
        renderTOC();
        return;
      }

      els.empty.style.display = "none";
      els.statusPill.textContent = `${filtered.length} / ${SNIPPETS.length} shown`;

      els.list.innerHTML = filtered.map((s, idx) => {
        const key = snippetKey(s);
        const codeHtml = injectSearchMarks(s.code, q);

        return `
          <section class="card" data-idx="${idx}">
            <div class="cardHead">
              <div class="meta">
                <div class="title">${escapeHtml(s.projectname)} <span style="color:var(--muted);font-weight:600;">(${escapeHtml(s.filename)})</span></div>
                <div class="badges">
                  <span class="badge accent">${escapeHtml(s.language)}</span>
                  <span class="badge">${s.code.length.toLocaleString()} chars</span>
                </div>
              </div>
              <div class="cardActions">
                <button class="smallBtn" data-action="toggle-notes" data-key="${escapeHtml(key)}">Notes</button>
                <button class="smallBtn" data-action="copy" data-code="${escapeHtml(s.code)}">Copy</button>
              </div>
            </div>

            <div class="${wrapOn ? "wrap" : ""}">
              <pre class="line-numbers" style="--codeSize:${codeSize}px"><code class="language-${escapeHtml(s.language)}">${codeHtml}</code></pre>
            </div>

            <div class="hintRow">
              <div>Tip: Search highlights terms. Use TOC to jump to classes/functions.</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="smallBtn" data-action="scroll-top">Top</button>
                <button class="smallBtn" data-action="scroll-bottom">Bottom</button>
              </div>
            </div>

            <div class="notes" id="${escapeHtml(key)}">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;">
                <div style="font-weight:700;">Notes</div>
                <div style="font-size:12px;color:var(--muted);">Saved locally</div>
              </div>
              <textarea placeholder="Write notes…"
                data-note-key="${escapeHtml(key)}">${escapeHtml(getSavedNote(key))}</textarea>
              <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
                <button class="smallBtn" data-action="save-note" data-key="${escapeHtml(key)}">Save</button>
                <button class="smallBtn" data-action="clear-note" data-key="${escapeHtml(key)}">Clear</button>
              </div>
            </div>
          </section>
        `;
      }).join("");

      Prism.highlightAllUnder(els.list);

      const query = safeString(q).trim();
      els.matchCount.textContent = query ? String(els.list.querySelectorAll("mark").length) : "0";

      renderTOC();
    }

    // ----------------------------
    // IO (manifest + file load)
    // ----------------------------
    async function loadManifest() {
      try {
        const res = await fetch(MANIFEST, { cache: "no-store" });
        if (!res.ok) throw new Error(`Manifest not found: ${MANIFEST}`);
        const list = await res.json();
        if (!Array.isArray(list)) throw new Error("index.json must be an array of filenames");

        FILES = list.filter(Boolean);
        els.fileCount.textContent = String(FILES.length);

        els.fileSelect.innerHTML =
          `<option value="">Select a file…</option>` +
          FILES.map(fn => {
            const meta = parseFilename(fn);
            const label = `${meta.language} • ${meta.projectname}`;
            return `<option value="${escapeHtml(fn)}">${escapeHtml(label)} — ${escapeHtml(fn)}</option>`;
          }).join("");

        els.statusPill.textContent = `Ready (${FILES.length} files)`;
      } catch (e) {
        console.error(e);
        els.statusPill.textContent = "Manifest error";
        els.fileSelect.innerHTML = `<option value="">Missing code/index.json</option>`;
        els.empty.style.display = "block";
        els.empty.innerHTML = `
          <div style="font-weight:700;color:rgba(255,255,255,0.9);margin-bottom:6px;">Missing /code/index.json</div>
          <div>
            Create <b>code/index.json</b> as an array of filenames.
            Example:
            <div style="margin-top:10px;border:1px solid var(--border);background:rgba(0,0,0,0.22);border-radius:14px;padding:12px;font-family:var(--codeFont);font-size:12px;overflow:auto;">
              ["python_ROS2Bot.json","javascript_WebUI.json"]
            </div>
          </div>
        `;
      }
    }

    async function loadCodeFile(filename) {
      if (!filename) return;

      const meta = parseFilename(filename);

      try {
        els.statusPill.textContent = `Loading ${meta.filename}…`;

        const res = await fetch(`${CODE_DIR}/${meta.filename}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`Could not load ${meta.filename}`);

        const codeText = await res.text();

        SNIPPETS = [{
          filename: meta.filename,
          language: meta.language,
          projectname: meta.projectname,
          code: codeText.replace(/\r\n/g, "\n")
        }];

        computeFiltersFromSnippets();
        els.projectSelect.value = "";
        els.languageSelect.value = "";

        toast("Loaded code file");
        els.statusPill.textContent = `${meta.language} • ${meta.projectname}`;
        render();
      } catch (e) {
        console.error(e);
        toast("Failed to load file");
        els.statusPill.textContent = "Load error";
        SNIPPETS = [];
        render();
      }
    }

    // ----------------------------
    // Events
    // ----------------------------
    els.fileSelect.addEventListener("change", () => loadCodeFile(els.fileSelect.value));
    els.projectSelect.addEventListener("change", render);
    els.languageSelect.addEventListener("change", render);
    els.searchInput.addEventListener("input", () => {
      clearTimeout(window.__searchT);
      window.__searchT = setTimeout(render, 120);
    });

    els.wrapBtn.addEventListener("click", () => {
      wrapOn = !wrapOn;
      els.wrapBtn.textContent = `Wrap: ${wrapOn ? "ON" : "OFF"}`;
      toast(`Wrap ${wrapOn ? "enabled" : "disabled"}`);
      render();
    });

    els.fontMinusBtn.addEventListener("click", () => {
      codeSize = Math.max(11, codeSize - 1);
      toast(`Font size: ${codeSize}px`);
      render();
    });

    els.fontPlusBtn.addEventListener("click", () => {
      codeSize = Math.min(20, codeSize + 1);
      toast(`Font size: ${codeSize}px`);
      render();
    });

    els.clearNotesBtn.addEventListener("click", () => {
      const ok = confirm("Clear ALL saved notes? (This cannot be undone)");
      if (!ok) return;
      clearAllNotes();
      toast("All notes cleared");
      render();
    });

    els.list.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const card = e.target.closest(".card");
      if (!action || !card) return;

      if (action === "toggle-notes") {
        const key = btn.getAttribute("data-key");
        const panel = document.getElementById(key);
        if (panel) panel.classList.toggle("open");
        return;
      }

      if (action === "copy") {
        const code = btn.getAttribute("data-code") || "";
        try { await copyToClipboard(code); toast("Copied"); }
        catch { toast("Copy failed"); }
        return;
      }

      if (action === "save-note") {
        const key = btn.getAttribute("data-key");
        const ta = els.list.querySelector(`textarea[data-note-key="${CSS.escape(key)}"]`);
        if (!ta) return;
        setSavedNote(key, ta.value);
        toast("Note saved");
        return;
      }

      if (action === "clear-note") {
        const key = btn.getAttribute("data-key");
        const ta = els.list.querySelector(`textarea[data-note-key="${CSS.escape(key)}"]`);
        if (!ta) return;
        ta.value = "";
        setSavedNote(key, "");
        toast("Note cleared");
        return;
      }

      if (action === "scroll-top") {
        card.scrollIntoView({ behavior: "smooth", block: "start" });
        return;
      }

      if (action === "scroll-bottom") {
        card.scrollIntoView({ behavior: "smooth", block: "end" });
        return;
      }
    });

    els.list.addEventListener("input", (e) => {
      const ta = e.target.closest("textarea[data-note-key]");
      if (!ta) return;
      const key = ta.getAttribute("data-note-key");
      clearTimeout(window.__noteT);
      window.__noteT = setTimeout(() => setSavedNote(key, ta.value), 250);
    });

    // TOC click handling (desktop + mobile drawer)
    function handleTocClick(e){
      const btn = e.target.closest(".tocItem");
      if (!btn) return;
      const idx = Number(btn.getAttribute("data-toc-idx"));
      const item = TOC[idx];
      if (!item) return;
      scrollToLine(item.line);
      closeDrawer();
    }
    els.tocBody.addEventListener("click", handleTocClick);
    els.drawerBody.addEventListener("click", handleTocClick);

    els.tocRefreshBtn.addEventListener("click", () => {
      renderTOC();
      toast("TOC refreshed");
    });

    // Mobile drawer
    els.tocFab.addEventListener("click", () => openDrawer());
    els.drawerOverlay.addEventListener("click", () => closeDrawer());
    els.drawerCloseBtn.addEventListener("click", () => closeDrawer());

    // ----------------------------
    // Init
    // ----------------------------
    render();
    loadManifest();
  </script>
</body>
</html>