<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tektos — Face ID</title>

  <style>
    :root{
      --bg: #f4f7ff;
      --bg2:#eef3ff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#5b6b86;

      --blue:#3b82f6;
      --blue2:#2563eb;
      --lav:#7c3aed;

      --stroke: rgba(15, 23, 42, .10);
      --shadow: 0 22px 55px rgba(15, 23, 42, .12);

      --r30: 30px;
      --r24: 24px;
      --r18: 18px;
      --r14: 14px;

      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 70% 35%, rgba(37,99,235,.16), transparent 62%),
        radial-gradient(900px 520px at 35% 75%, rgba(59,130,246,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    .page{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 18px 40px;
    }

    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 10px 6px 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .mark{
      width:40px; height:40px;
      border-radius: 14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.85), transparent 60%),
        linear-gradient(135deg, rgba(59,130,246,.95), rgba(37,99,235,.95), rgba(124,58,237,.85));
      box-shadow: 0 16px 40px rgba(37,99,235,.22);
    }

    .brandTitle{
      display:grid;
      gap:2px;
      line-height:1.15;
    }
    .brandTitle b{ font-size:14px; letter-spacing:.2px; }
    .brandTitle span{ font-size:12px; color:var(--muted); }

    .navLinks{
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .navLinks a{
      color:inherit;
      text-decoration:none;
      padding:8px 10px;
      border-radius: 999px;
      transition: background .12s ease;
    }
    .navLinks a:hover{ background: rgba(15,23,42,.04); }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background: rgba(255,255,255,.72);
      border:1px solid var(--stroke);
      border-radius: 999px;
      box-shadow: 0 10px 28px rgba(15,23,42,.08);
      backdrop-filter: blur(8px);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      min-width: 170px;
      justify-content:center;
    }
    .dot{
      width:9px; height:9px; border-radius: 999px;
      background:#fbbf24;
      box-shadow:0 0 0 4px rgba(251,191,36,.18);
    }

    .hero{
      position:relative;
      background: rgba(255,255,255,.70);
      border: 1px solid var(--stroke);
      border-radius: var(--r30);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 22px;
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 22px;
      align-items: stretch;
      min-height: 560px;
    }

    @media (max-width: 980px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ min-width: unset; }
      .pill{ justify-content:flex-start; }
      .hero{ padding: 16px; }
      .heroGrid{ grid-template-columns: 1fr; min-height: unset; }
    }

    .copy{
      padding: 12px 10px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap: 14px;
      position:relative;
      z-index:2;
    }

    .kicker{
      font-size:12px;
      color: var(--muted);
      letter-spacing:.16em;
      text-transform: uppercase;
    }

    .headline{
      font-size: clamp(44px, 5.6vw, 76px);
      line-height: .92;
      letter-spacing: -0.02em;
      margin:0;
      font-weight: 900;
    }
    .headline .accentDot{
      display:inline-block;
      width:12px; height:12px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--blue), var(--lav));
      box-shadow: 0 0 0 6px rgba(59,130,246,.14);
      vertical-align: middle;
      margin-left: 10px;
    }

    .sub{
      max-width: 64ch;
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.65;
    }

    .meaning{
      border-radius: var(--r18);
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.85);
      padding: 12px 12px;
      display:grid;
      gap:6px;
    }
    .meaning b{
      font-size:12px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(15,23,42,.70);
    }
    .meaning p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.55;
    }

    .btnRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 4px;
    }

    button{
      appearance:none;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      color: var(--ink);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 14px 35px rgba(15,23,42,.10);
      min-height: 44px;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(15,23,42,.16); }
    button:active{ transform: translateY(0px) scale(.99); }

    .primary{
      background: linear-gradient(135deg, rgba(59,130,246,.16), rgba(124,58,237,.10));
      border-color: rgba(37,99,235,.20);
    }
    .danger{
      background: rgba(239,68,68,.06);
      border-color: rgba(239,68,68,.18);
    }

    .log{
      margin-top: 4px;
      max-height: 240px;
      overflow:auto;
      border-radius: var(--r18);
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.80);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .entry{
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.95);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .entry strong{ color: var(--ink); }

    .right{
      position:relative;
      display:grid;
      grid-template-rows: 1fr auto;
      gap: 14px;
      padding: 8px;
      z-index:2;
    }

    .orb{
      position:relative;
      border-radius: var(--r30);
      background: radial-gradient(70% 85% at 55% 35%, rgba(59,130,246,.22), rgba(37,99,235,.10), rgba(255,255,255,.0));
      border: 1px solid rgba(37,99,235,.18);
      overflow:hidden;
      min-height: 360px;
      display:grid;
      place-items:center;
    }

    .circleStage{
      width: min(390px, 92%);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      background:
        radial-gradient(14px 14px at 30% 28%, rgba(255,255,255,.9), transparent 60%),
        radial-gradient(420px 420px at 50% 50%, rgba(37,99,235,.20), rgba(59,130,246,.12), rgba(255,255,255,.35));
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 30px 70px rgba(37,99,235,.18);
      overflow:hidden;
      position:relative;
    }

    #video{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scaleX(-1);
      filter: saturate(1.05) contrast(1.02);
    }
    #canvas{ display:none; }

    .ring{
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      pointer-events:none;
      border: 1px solid rgba(255,255,255,.55);
      box-shadow:
        inset 0 0 0 1px rgba(37,99,235,.18),
        inset 0 0 50px rgba(37,99,235,.14);
    }

    .sweep{
      position:absolute;
      left: 10px; right: 10px; top: 10px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(59,130,246,.95), rgba(124,58,237,.85), transparent);
      filter: drop-shadow(0 0 18px rgba(37,99,235,.35));
      animation: sweep 2.2s linear infinite;
      opacity:.65;
      pointer-events:none;
      display:none;
    }
    @keyframes sweep{
      0%{ transform: translateY(0); opacity:.25; }
      10%{ opacity:.70; }
      50%{ opacity:.85; }
      90%{ opacity:.70; }
      100%{ transform: translateY(calc(100% - 24px)); opacity:.25; }
    }

    .panel{
      border-radius: var(--r24);
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.82);
      box-shadow: 0 16px 40px rgba(15,23,42,.10);
      padding: 14px;
      display:grid;
      gap:10px;
    }

    .who{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .who h2{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      font-weight:700;
      letter-spacing:.12em;
      text-transform: uppercase;
    }
    .bigName{
      margin:6px 0 0 0;
      font-size: 28px;
      letter-spacing: -0.01em;
      font-weight: 900;
      line-height:1.05;
    }

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .metrics{ grid-template-columns: 1fr; }
      button{ width: 100%; }
      .btnRow{ gap:10px; }
    }

    .metric{
      border-radius: var(--r14);
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.92);
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size:12px;
    }
    .metric b{ color: var(--ink); font-weight: 800; }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 99;
      backdrop-filter: blur(8px);
    }
    .modal{
      width: min(520px, 100%);
      border-radius: var(--r30);
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 30px 80px rgba(15,23,42,.20);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .modalHead h3{ margin:0; font-size:14px; }
    .modalBody{ padding: 16px; display:grid; gap:12px; }
    .modalBody p{ margin:0; color: var(--muted); font-size: 13px; line-height:1.55; }
    .field{ display:grid; gap:8px; }
    .field label{ font-size:12px; color: var(--muted); }

    input{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.98);
      padding: 12px 14px;
      outline:none;
      font-size: 14px;
      color: var(--ink);
      box-shadow: 0 10px 26px rgba(15,23,42,.08);
    }
    input:focus{
      border-color: rgba(37,99,235,.28);
      box-shadow: 0 0 0 5px rgba(37,99,235,.12);
    }

    .modalActions{
      padding: 14px 16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      border-top: 1px solid rgba(15,23,42,.08);
    }

    .burst{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .35s ease;
      background:
        radial-gradient(500px 360px at 35% 40%, rgba(255, 215, 128, .30), transparent 60%),
        radial-gradient(520px 380px at 70% 55%, rgba(59,130,246,.18), transparent 62%),
        radial-gradient(560px 420px at 55% 70%, rgba(124,58,237,.14), transparent 64%);
    }
    .burst.on{ opacity:1; }

    .toast button{
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.98);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.08);
    }
    .toast button:hover{ transform: translateY(-1px); }
    .toast button:active{ transform: translateY(0px) scale(.99); }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 999px;
      padding: 12px 14px;
      font-size: 12px;
      color: var(--ink);
      display:none;
      gap:10px;
      align-items:center;
      box-shadow: 0 18px 55px rgba(15,23,42,.18);
      z-index: 120;
      backdrop-filter: blur(8px);
    }
    .toast .tDot{
      width:9px; height:9px; border-radius:999px;
      background: var(--ok);
      box-shadow:0 0 0 4px rgba(34,197,94,.18);
    }

    /* Floating mobile scan button */
    #fabCapture{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 140;
      padding: 14px 18px;
      border-radius: 999px;
      font-weight: 800;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="mark"></div>
        <div class="brandTitle">
          <b>Tektos</b>
          <span>Face ID • Recognition + Live Enrollment</span>
        </div>
      </div>

      <div class="navLinks" aria-label="Navigation">
        <a href="javascript:void(0)">Dashboard</a>
        <a href="javascript:void(0)">Enrollment</a>
        <a href="javascript:void(0)">Security</a>
      </div>

      <div class="pill" role="status" aria-live="polite">
        <span class="dot" id="netDot"></span>
        <span id="netText">Not connected</span>
      </div>
    </div>

    <section class="hero">
      <div class="heroGrid">
        <div class="copy">
          <div class="kicker">VISION • IDENTITY • TEKTOS</div>
          <h1 class="headline">TEKTOS<span class="accentDot"></span></h1>

          <p class="sub">
            A clean Face ID workflow for your robot. Recognize known users instantly, or enroll new users in one step.
          </p>

          <div class="meaning">
            <b>Meaning</b>
            <p>
              <strong>Tektos</strong> is inspired by the Greek root <em>tektōn</em>, associated with a builder/craftsman.
              Here, Tektos “builds” trust by verifying identity before actions are allowed.
            </p>
          </div>

          <div class="btnRow">
            <button class="primary" id="btnStart">Start Camera</button>
            <button class="primary" id="btnCapture">Capture / Scan</button>
            <button class="danger" id="btnStop">Stop</button>
          </div>

          <div class="log" id="log"></div>
        </div>

        <div class="right">
          <div class="orb">
            <div class="circleStage">
              <video id="video" playsinline autoplay muted></video>
              <canvas id="canvas"></canvas>

              <div class="burst" id="burst"></div>

              <div class="ring"></div>
              <div class="sweep" id="scanLine"></div>
            </div>
          </div>

          <div class="panel">
            <div class="who">
              <div>
                <h2>Current identity</h2>
                <div class="bigName" id="identityName">—</div>
              </div>
            </div>

            <div class="metrics">
              <div class="metric"><span>Distance</span><b id="identityDist">—</b></div>
              <div class="metric"><span>Status</span><b id="identityStatus">—</b></div>
              <div class="metric"><span>Last update</span><b id="identityTime">—</b></div>
              <button id="btnDebugOn">Debug ON</button>
              <button id="btnDebugOff">Debug OFF</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <h3 id="modalTitle">New user detected</h3>
        <button id="btnCloseModal">Close</button>
      </div>
      <div class="modalBody">
        <p>
          Your face was not recognized. Enter your name to enroll. This stores a face encoding in your local database.
        </p>
        <div class="field">
          <label for="nameInput">Name</label>
          <input id="nameInput" placeholder="e.g., Stevenson" autocomplete="name" />
        </div>
      </div>
      <div class="modalActions">
        <button id="btnEnroll" class="primary">Enroll Now</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite">
    <span class="tDot"></span>
    <span id="toastText">Saved.</span>
    <button id="toastRestartBtn" style="display:none">Restart</button>
  </div>

  <button id="fabCapture" class="primary" aria-label="Capture and Scan">Scan</button>

<script>
(() => {
  const API_RECOGNIZE = "https://f13d7eaca0da.ngrok-free.app/recognize/";
  const API_ENROLL    = "https://f13d7eaca0da.ngrok-free.app/enroll/";

  const JPEG_QUALITY = 0.86;
  const CAPTURE_W    = 720;

  const SUCCESS_BURST_MS = 900;
  const TOAST_MS = 1600;

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const logEl = document.getElementById("log");

  const btnStart = document.getElementById("btnStart");
  const btnCapture = document.getElementById("btnCapture");
  const btnStop = document.getElementById("btnStop");
  const fabCapture = document.getElementById("fabCapture");

  const identityName = document.getElementById("identityName");
  const identityDist = document.getElementById("identityDist");
  const identityStatus = document.getElementById("identityStatus");
  const identityTime = document.getElementById("identityTime");

  const netDot = document.getElementById("netDot");
  const netText = document.getElementById("netText");

  const modalBack = document.getElementById("modalBack");
  const nameInput = document.getElementById("nameInput");
  const btnEnroll = document.getElementById("btnEnroll");
  const btnCloseModal = document.getElementById("btnCloseModal");

  const burst = document.getElementById("burst");
  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");
  const toastRestartBtn = document.getElementById("toastRestartBtn");

  const scanLine = document.getElementById("scanLine");

  const btnDebugOn = document.getElementById("btnDebugOn");
  const btnDebugOff = document.getElementById("btnDebugOff");

  let stream = null;
  let busy = false;
  let lastFrameBlob = null;

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function setNetwork(ok) {
    if (!netDot || !netText) return;
    netDot.style.background = ok ? "#22c55e" : "#fbbf24";
    netDot.style.boxShadow = ok
      ? "0 0 0 4px rgba(34,197,94,.18)"
      : "0 0 0 4px rgba(251,191,36,.18)";
    netText.textContent = ok ? "Connected" : "Not connected";
  }

  function setIdentity({ name="—", distance="—", status="—", timestamp=null } = {}) {
    if (identityName) identityName.textContent = name;
    if (identityDist) identityDist.textContent = (distance === "—") ? "—" : Number(distance).toFixed(2);
    if (identityStatus) identityStatus.textContent = status;
    if (identityTime) identityTime.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : "—";
  }

  function showModal(open) {
    if (!modalBack) return;
    modalBack.style.display = open ? "flex" : "none";
    if (open && nameInput) {
      nameInput.value = "";
      nameInput.focus();
    }
  }

  function pulseSuccess() {
    if (!burst) return;
    burst.classList.add("on");
    setTimeout(() => burst.classList.remove("on"), SUCCESS_BURST_MS);
  }

  function showToast(msg, { showRestart=false } = {}) {
    if (!toast || !toastText) return;
    toastText.textContent = msg;
    if (toastRestartBtn) toastRestartBtn.style.display = showRestart ? "inline-flex" : "none";
    toast.style.display = "flex";
    setTimeout(() => (toast.style.display = "none"), TOAST_MS);
  }

  function setScanning(on) {
    if (!scanLine) return;
    scanLine.style.display = on ? "block" : "none";
  }

  let DEBUG_ENABLED = false;
  function setDebugEnabled(enabled) {
    DEBUG_ENABLED = enabled;
    if (logEl) logEl.style.display = enabled ? "flex" : "none";
    showToast(enabled ? "Debug enabled." : "Debug disabled.");
  }
  function dlog(...args) {
    if (!DEBUG_ENABLED) return;
    console.log("[TEKTOS]", ...args);
    if (!logEl) return;
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `<strong>Debug</strong> — ${escapeHtml(args.map(String).join(" "))}`;
    logEl.prepend(div);
  }

  btnDebugOn?.addEventListener("click", () => {
    const pwd = prompt("Enter debug password:");
    if (pwd === "cisco") setDebugEnabled(true);
    else {
      setDebugEnabled(false);
      showToast("Wrong password. Debug locked.");
    }
  });
  btnDebugOff?.addEventListener("click", () => setDebugEnabled(false));
  setDebugEnabled(false);

  async function startCamera() {
    if (stream) return;
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
    dlog("Camera started.");
  }

  function stopCamera() {
    if (stream) {
      for (const t of stream.getTracks()) t.stop();
      stream = null;
    }
    video.srcObject = null;
    busy = false;
    lastFrameBlob = null;
    setIdentity({ name:"—", distance:"—", status:"—", timestamp:null });
    showToast("Stopped.");
    dlog("Camera stopped.");
  }

  async function captureFrameBlob() {
    if (!canvas || !video.videoWidth) return null;
    const vw = video.videoWidth;
    const scale = Math.min(1, CAPTURE_W / vw);
    const cw = Math.round(vw * scale);
    const ch = Math.round(video.videoHeight * scale);

    canvas.width = cw;
    canvas.height = ch;

    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    ctx.drawImage(video, 0, 0, cw, ch);

    return await new Promise((resolve) => {
      canvas.toBlob((blob) => resolve(blob), "image/jpeg", JPEG_QUALITY);
    });
  }

  async function apiRecognize(imageBlob) {
    const form = new FormData();
    form.append("image", imageBlob, "frame.jpg");
    const res = await fetch(API_RECOGNIZE, { method: "POST", body: form });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || `HTTP ${res.status}`);
    return json;
  }

  async function apiEnroll(imageBlob, name) {
    const form = new FormData();
    form.append("image", imageBlob, "frame.jpg");
    form.append("name", name);
    const res = await fetch(API_ENROLL, { method: "POST", body: form });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || `HTTP ${res.status}`);
    return json;
  }

  async function scanOnce() {
    if (busy) return;
    if (!stream) { showToast("Start camera first."); return; }

    busy = true;
    setScanning(true);

    try {
      const blob = await captureFrameBlob();
      if (!blob) return;
      lastFrameBlob = blob;

      const data = await apiRecognize(blob);
      setNetwork(true);

      if (data.recognized) {
        setIdentity({ name: data.name, distance: data.distance, status: "Recognized", timestamp: data.timestamp });
        pulseSuccess();
        showToast(`Welcome, ${data.name}.`);
      } else {
        setIdentity({ name: "Unknown", distance: data.distance, status: "Not recognized", timestamp: data.timestamp });
        showToast("Unknown user. Enrollment required.");
        showModal(true);
      }

      dlog("Recognize response:", JSON.stringify(data));
    } catch (err) {
      setNetwork(false);
      dlog("Recognize error:", err.message || err);
      showToast("Backend error. Tap Restart to try again.", { showRestart: true });
    } finally {
      busy = false;
      setScanning(false);
    }
  }

  async function restartFlow() {
    try {
      showModal(false);
      stopCamera();
      await startCamera();
      setNetwork(false);
      showToast("Restarted. Try again.", { showRestart: false });
    } catch {
      showToast("Restart failed. Refresh the page.");
    }
  }
  toastRestartBtn?.addEventListener("click", restartFlow);

  async function enrollNow() {
    if (!lastFrameBlob) { showToast("No frame to enroll. Scan again."); return; }
    const name = (nameInput?.value || "").trim();
    if (!name) { showToast("Enter a name."); return; }

    busy = true;
    setScanning(true);

    try {
      const out = await apiEnroll(lastFrameBlob, name);
      setNetwork(true);
      showModal(false);
      pulseSuccess();
      showToast(`Enrolled ${out.name} (${out.samples_total} samples).`);
      setTimeout(() => scanOnce(), 250);
    } catch (err) {
      setNetwork(false);
      dlog("Enroll error:", err.message || err);
      showToast("Backend error. Tap Restart to try again.", { showRestart: true });
    } finally {
      busy = false;
      setScanning(false);
    }
  }

  btnStart?.addEventListener("click", async () => {
    await startCamera();
    showToast("Camera ready. Tap Capture / Scan.");
  });

  btnCapture?.addEventListener("click", async () => {
    await startCamera();
    await scanOnce();
  });

  fabCapture?.addEventListener("click", async () => {
    await startCamera();
    await scanOnce();
  });

  btnStop?.addEventListener("click", stopCamera);

  btnEnroll?.addEventListener("click", enrollNow);
  btnCloseModal?.addEventListener("click", () => { showModal(false); showToast("Enrollment canceled."); });
  modalBack?.addEventListener("click", (e) => { if (e.target === modalBack) showModal(false); });

  nameInput?.addEventListener("keydown", (e) => { if (e.key === "Enter") enrollNow(); });

  setNetwork(false);
  setIdentity({ name:"—", distance:"—", status:"—", timestamp:null });
})();
</script>
</body>
</html>