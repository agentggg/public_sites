<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NAV-OPS // Hand Landmarks</title>

  <style>
    :root{
      /* =========================
         NEW THEME: "PORCELAIN OPS"
         - NOT dark
         - NOT common grey/green
         - Clean, titanium, porcelain, ink
      ========================= */
      --paper0:#fbfaf7;
      --paper1:#f4f2ee;
      --paper2:#ebe7e1;

      --ink0:#0b0e14;
      --ink1:rgba(11,14,20,.78);
      --ink2:rgba(11,14,20,.58);

      --glass: rgba(255,255,255,.62);
      --glass2: rgba(255,255,255,.38);

      --line: rgba(11,14,20,.14);
      --line2: rgba(11,14,20,.20);

      /* accents (not neon, not cyber-green) */
      --cobalt: rgba(62, 124, 255, .92);
      --cobaltSoft: rgba(62, 124, 255, .14);

      --copper: rgba(214, 119, 64, .92);
      --copperSoft: rgba(214, 119, 64, .14);

      --ok: rgba(0, 170, 145, .92);
      --warn: rgba(214, 146, 0, .92);
      --bad: rgba(210, 54, 95, .92);

      --shadow: 0 28px 90px rgba(11,14,20,.12);
      --shadow2: 0 18px 60px rgba(11,14,20,.10);

      --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color: var(--ink0);
      font-family: var(--sans);
      background:
        radial-gradient(900px 520px at 10% 12%, rgba(62,124,255,.14), transparent 62%),
        radial-gradient(880px 520px at 88% 18%, rgba(214,119,64,.12), transparent 64%),
        radial-gradient(1100px 640px at 45% 110%, rgba(0,170,145,.10), transparent 62%),
        linear-gradient(180deg, var(--paper0), var(--paper2));
      overflow:hidden;
    }

    .wrap{
      min-height:100vh;
      padding: calc(14px + env(safe-area-inset-top)) 14px calc(16px + env(safe-area-inset-bottom));
      display:grid;
      grid-template-columns: 392px 1fr;
      gap: 14px;
    }

    /* =========================
       LEFT: Instrument Rail + Modules (NO ‚Äúcards‚Äù)
       ========================= */
    .stack{
      position:relative;
      min-height:0;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.38));
      border: 1px solid rgba(11,14,20,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* left instrument rail */
    .stack::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width: 58px;
      background:
        linear-gradient(180deg, rgba(11,14,20,.06), rgba(11,14,20,.03));
      border-right: 1px solid rgba(11,14,20,.10);
    }

    .stackHead{
      position:relative;
      padding: 14px 14px 12px 72px;
      border-bottom: 1px solid rgba(11,14,20,.12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.54));
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .brand .k{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(11,14,20,.60);
    }
    .brand .t{
      font-size: 18px;
      font-weight: 860;
      letter-spacing: .01em;
      display:flex;
      align-items:baseline;
      gap: 10px;
      flex-wrap:wrap;
      color: rgba(11,14,20,.90);
    }
    .brand .t span{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(11,14,20,.50);
    }

    /* rail markers */
    .railMarks{
      position:absolute;
      left: 0; top: 0; bottom: 0;
      width: 58px;
      display:flex;
      flex-direction:column;
      padding: 14px 0;
      gap: 10px;
      align-items:center;
      pointer-events:none;
    }
    .mark{
      width: 30px; height: 30px;
      border-radius: 12px;
      border: 1px solid rgba(11,14,20,.14);
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 22px rgba(11,14,20,.07);
      position:relative;
      overflow:hidden;
    }
    .mark::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg,
        rgba(62,124,255,.22),
        rgba(214,119,64,.18),
        rgba(0,170,145,.18),
        rgba(62,124,255,.22));
      opacity:.35;
      transform: rotate(12deg);
    }

    .modules{
      padding: 12px 12px 12px 72px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:auto;
      min-height:0;
    }

    /* MODULE SLICE (not card) */
    .module{
      position:relative;
      border: 1px solid rgba(11,14,20,.12);
      background: rgba(255,255,255,.52);
      box-shadow: var(--shadow2);
      border-radius: 16px;
      overflow:hidden;

      /* angled right-cut (distinct silhouette) */
      clip-path: polygon(0 0, calc(100% - 18px) 0, 100% 18px, 100% 100%, 0 100%);
    }

    .moduleBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(11,14,20,.10);
      background: rgba(255,255,255,.50);
    }

    .moduleBody{
      padding: 12px;
    }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .row.space{ justify-content:space-between; }

    /* Status chip is NOT a pill-box style; it‚Äôs a ‚Äútape label‚Äù */
    .tape{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(11,14,20,.72);

      border-left: 3px solid rgba(11,14,20,.22);
      background: linear-gradient(90deg, rgba(11,14,20,.06), transparent 55%);
    }

    .sig{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(11,14,20,.28);
      box-shadow: 0 0 0 8px rgba(11,14,20,.06);
      flex: 0 0 auto;
    }
    .sig.ok{ background: var(--ok); box-shadow: 0 0 0 8px rgba(0,170,145,.12); }
    .sig.warn{ background: var(--warn); box-shadow: 0 0 0 8px rgba(214,146,0,.12); }
    .sig.bad{ background: var(--bad); box-shadow: 0 0 0 8px rgba(210,54,95,.12); }

    /* Buttons: ‚Äúmachined tabs‚Äù, not boxed buttons */
    .btn{
      border-radius: 14px;
      border: 1px solid rgba(11,14,20,.16);
      background:
        linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.40));
      color: rgba(11,14,20,.86);
      padding: 12px 12px;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .16em;
      text-transform: uppercase;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      user-select:none;
      min-width: 152px;
      text-align:center;
      box-shadow: 0 10px 22px rgba(11,14,20,.08);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(11,14,20,.26); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn.primary{
      border-color: rgba(62,124,255,.30);
      box-shadow: 0 14px 26px rgba(62,124,255,.12);
      background:
        linear-gradient(180deg, rgba(62,124,255,.18), rgba(255,255,255,.55));
    }

    /* Segmented controls: now ‚Äúcapsule strip‚Äù (not boxes) */
    .strip{
      display:flex;
      gap: 6px;
      flex-wrap:wrap;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(11,14,20,.14);
      background: rgba(255,255,255,.56);
    }
    .strip button{
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(11,14,20,.70);
      padding: 9px 10px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .strip button:hover{ transform: translateY(-1px); }
    .strip button.active{
      border-color: rgba(62,124,255,.26);
      background: rgba(62,124,255,.10);
      color: rgba(11,14,20,.90);
    }

    /* Toggles: ‚Äúinline switch row‚Äù with divider, not a box */
    .switchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-top: 1px solid rgba(11,14,20,.10);
      background: rgba(255,255,255,.36);
      cursor:pointer;
      user-select:none;
    }
    .switchRow:first-child{ border-top: 0; }
    .switchRow .l{
      display:flex; flex-direction:column; gap: 4px;
      min-width: 0;
    }
    .switchRow .k{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(11,14,20,.78);
    }
    .switchRow .p{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(11,14,20,.52);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }

    .switch{
      width: 46px; height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(11,14,20,.18);
      background: rgba(255,255,255,.70);
      position: relative;
      flex: 0 0 auto;
      box-shadow: 0 10px 18px rgba(11,14,20,.07);
    }
    .knob{
      width: 22px; height: 22px; border-radius: 999px;
      background: rgba(11,14,20,.88);
      position:absolute; top: 1px; left: 2px;
      transition: left 140ms ease, background 140ms ease;
      box-shadow: 0 10px 18px rgba(11,14,20,.14);
    }
    .switchRow.on .switch{
      border-color: rgba(0,170,145,.22);
      background: rgba(0,170,145,.10);
    }
    .switchRow.on .knob{
      left: 22px;
      background: rgba(0,170,145,.92);
    }

    /* Key/Value block: ‚Äúspec sheet‚Äù look */
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 10px;
      align-items:center;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(11,14,20,.72);
    }
    .kv b{
      color: rgba(11,14,20,.92);
      font-weight: 850;
    }

    /* =========================
       RIGHT: Viewport (bright frame, not dark)
       ========================= */
    .view{
      border-radius: 22px;
      border: 1px solid rgba(11,14,20,.12);
      background:
        radial-gradient(900px 520px at 50% 20%, rgba(255,255,255,.70), rgba(255,255,255,.40)),
        linear-gradient(180deg, rgba(255,255,255,.52), rgba(255,255,255,.34));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height:0;

      /* distinct cut */
      clip-path: polygon(0 0, calc(100% - 24px) 0, 100% 24px, 100% 100%, 0 100%);
    }

    /* Top HUD tags now light */
    .hudTop{
      position:absolute; left: 12px; right: 12px; top: 12px;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      z-index: 30;
      pointer-events:none;
    }
    .hudTop .tag{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(11,14,20,.70);
      border: 1px solid rgba(11,14,20,.14);
      background: rgba(255,255,255,.62);
      padding: 10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(11,14,20,.08);
    }

    /* Scan frame is NOT a ‚Äúbox‚Äù; it‚Äôs a ‚Äúreticle bracket + axis ticks‚Äù */
    .scanFrame{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 10;
      pointer-events:none;
    }
    .reticle{
      width: min(900px, calc(100% - 64px));
      aspect-ratio: 16/9;
      position:relative;
    }
    .axis{
      position:absolute; left:0; right:0; top:50%;
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(11,14,20,.18), transparent);
    }
    .axis.v{
      top:0; bottom:0; left:50%; right:auto;
      width:1px; height:auto;
      background: linear-gradient(180deg, transparent, rgba(11,14,20,.18), transparent);
    }
    .br{
      position:absolute;
      width: 84px; height: 84px;
      border: 2px solid rgba(62,124,255,.38);
      filter: drop-shadow(0 10px 20px rgba(62,124,255,.10));
    }
    .br1{ left: 0; top: 0; border-right:0; border-bottom:0; border-radius: 18px 0 0 0; }
    .br2{ right: 0; top: 0; border-left:0; border-bottom:0; border-radius: 0 18px 0 0; border-color: rgba(214,119,64,.34); filter: drop-shadow(0 10px 20px rgba(214,119,64,.10)); }
    .br3{ left: 0; bottom: 0; border-right:0; border-top:0; border-radius: 0 0 0 18px; border-color: rgba(0,170,145,.30); filter: drop-shadow(0 10px 20px rgba(0,170,145,.10)); }
    .br4{ right: 0; bottom: 0; border-left:0; border-top:0; border-radius: 0 0 18px 0; border-color: rgba(11,14,20,.20); filter: drop-shadow(0 10px 20px rgba(11,14,20,.08)); }

    video{
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scaleX(-1);
      opacity: .98;
      /* keep it crisp in bright UI */
      filter: contrast(1.06) saturate(1.04);
    }
    canvas.overlay{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
      z-index: 20;
    }

    /* Processing effect (light): ‚Äúcalibration wash‚Äù, not dark sweep */
    .wash{
      position:absolute; inset:-30%;
      opacity:0;
      background:
        conic-gradient(from 90deg at 50% 50%,
          transparent 0deg,
          rgba(62,124,255,.10) 18deg,
          rgba(214,119,64,.08) 34deg,
          transparent 70deg);
      filter: blur(10px);
      transform: rotate(0deg);
      pointer-events:none;
      z-index: 25;
    }
    .processing .wash{
      opacity:1;
      animation: wash 1.1s linear infinite;
    }
    @keyframes wash{
      0%{ transform: rotate(0deg); opacity:.25; }
      45%{ opacity:.60; }
      100%{ transform: rotate(360deg); opacity:.25; }
    }

    /* =========================
       TOAST (light)
       ========================= */
    .toastWrap{
      position: fixed;
      left: 12px; right: 12px;
      top: calc(12px + env(safe-area-inset-top));
      z-index: 80;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .toast{
      width: min(980px, 100%);
      border-radius: 16px;
      border: 1px solid rgba(11,14,20,.14);
      background: rgba(255,255,255,.72);
      box-shadow: 0 24px 80px rgba(11,14,20,.14);
      backdrop-filter: blur(16px);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 180ms ease, transform 180ms ease;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast .left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .toast .bar{
      width: 10px; height: 28px; border-radius: 999px;
      background: rgba(11,14,20,.25);
      box-shadow: 0 0 0 10px rgba(11,14,20,.05);
      flex: 0 0 auto;
    }
    .toast .bar.ok{ background: var(--ok); box-shadow: 0 0 0 10px rgba(0,170,145,.12); }
    .toast .bar.warn{ background: var(--warn); box-shadow: 0 0 0 10px rgba(214,146,0,.12); }
    .toast .bar.bad{ background: var(--bad); box-shadow: 0 0 0 10px rgba(210,54,95,.12); }
    .toast .t{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      margin:0;
      color: rgba(11,14,20,.88);
    }
    .toast .p{
      margin: 4px 0 0;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(11,14,20,.62);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 72vw;
    }
    .toast .hint{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(11,14,20,.56);
      letter-spacing: .12em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .stack{ order: 2; }
      .view{ order: 1; min-height: 62vh; }
      .switchRow .p{ max-width: 66vw; }
    }
  </style>
</head>

<body>
  <div class="toastWrap">
    <div class="toast" id="toast">
      <div class="left">
        <div class="bar" id="toastBar"></div>
        <div>
          <p class="t" id="toastT">NAV-OPS</p>
          <p class="p" id="toastP">‚Äî</p>
        </div>
      </div>
      <div class="hint" id="toastHint">‚Äî</div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT: Command / Telemetry -->
    <section class="stack">
      <div class="railMarks" aria-hidden="true">
        <div class="mark"></div>
        <div class="mark"></div>
        <div class="mark"></div>
      </div>

      <div class="stackHead">
        <div class="brand">
          <div class="k">NAV-OPS</div>
          <div class="t">
            Hand Landmarks
            <span id="sessionLine">session: ‚Äî</span>
          </div>
        </div>
      </div>

      <div class="modules">
        <!-- MODULE: CONTROL -->
        <div class="module">
          <div class="moduleBar">
            <div class="tape" title="System state">
              <span class="sig" id="sig"></span>
              <span id="statusText">STANDBY</span>
            </div>
            <div class="row">
              <button class="btn primary" id="startBtn">Camera On</button>
              <button class="btn" id="stopBtn" disabled>Camera Off</button>
              <button class="btn" id="debugBtn">Debug</button>
            </div>
          </div>
          <div class="moduleBody">
            <div class="row" style="justify-content:space-between">
              <div style="font-family:var(--mono); font-size:12px; letter-spacing:.18em; text-transform:uppercase; color:rgba(11,14,20,.64);">
                Camera
              </div>
              <div class="strip" aria-label="Camera selection">
                <button class="active" id="camFront" type="button">Front</button>
                <button id="camBack" type="button">Back</button>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="row" style="justify-content:space-between">
              <div style="font-family:var(--mono); font-size:12px; letter-spacing:.18em; text-transform:uppercase; color:rgba(11,14,20,.64);">
                Send Rate
              </div>
              <div class="strip" aria-label="Update rate">
                <button class="active" data-rate="normal" type="button">Normal</button>
                <button data-rate="fast" type="button">Fast</button>
                <button data-rate="battery" type="button">Battery</button>
                <button data-rate="pause" type="button">Pause</button>
              </div>
            </div>
          </div>
        </div>

        <!-- MODULE: TOGGLES (no boxes) -->
        <div class="module">
          <div class="moduleBar">
            <div style="font-family:var(--mono); font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:rgba(11,14,20,.68);">
              Overlay Controls
            </div>
            <div style="font-family:var(--mono); font-size:12px; color:rgba(11,14,20,.52); letter-spacing:.14em; text-transform:uppercase;">
              Live
            </div>
          </div>

          <div id="mirrorToggle" class="switchRow on" role="switch" aria-checked="true" tabindex="0">
            <div class="l">
              <div class="k">Mirror preview</div>
              <div class="p">Selfie orientation for intuitive control</div>
            </div>
            <div class="switch"><div class="knob"></div></div>
          </div>

          <div id="lmToggle" class="switchRow on" role="switch" aria-checked="true" tabindex="0">
            <div class="l">
              <div class="k">Landmarks overlay</div>
              <div class="p">Draw 21 points + hand skeleton</div>
            </div>
            <div class="switch"><div class="knob"></div></div>
          </div>

          <div id="lblToggle" class="switchRow on" role="switch" aria-checked="true" tabindex="0">
            <div class="l">
              <div class="k">Fingertip labels</div>
              <div class="p">Thumb / Index / Middle / Ring / Pinky</div>
            </div>
            <div class="switch"><div class="knob"></div></div>
          </div>
        </div>

        <!-- MODULE: TELEMETRY -->
        <div class="module">
          <div class="moduleBar">
            <div style="font-family:var(--mono); font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:rgba(11,14,20,.68);">
              Telemetry
            </div>
            <div style="font-family:var(--mono); font-size:12px; color:rgba(11,14,20,.52); letter-spacing:.14em; text-transform:uppercase;">
              Session
            </div>
          </div>
          <div class="moduleBody">
            <div class="kv">
              <div>Detected</div><b id="detectedLine">‚Äî</b>
              <div>Hand</div><b id="handed">‚Äî</b>
              <div>Latency</div><b id="lat">‚Äî</b>
              <div>Frame</div><b id="frameId">‚Äî</b>
              <div>JPEG</div><b id="jpegQ">0.72</b>
              <div>Rate</div><b id="rateOut">normal</b>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Viewport -->
    <section class="view" id="viewport">
      <div class="hudTop">
        <div class="tag" id="modeTag">TRACK ‚Ä¢ READY</div>
        <div class="tag" id="rateTag">NORMAL</div>
      </div>

      <div class="scanFrame" aria-hidden="true">
        <div class="reticle">
          <div class="axis"></div>
          <div class="axis v"></div>
          <div class="br br1"></div><div class="br br2"></div>
          <div class="br br3"></div><div class="br br4"></div>
        </div>
      </div>

      <video id="video" autoplay playsinline muted></video>
      <canvas class="overlay" id="overlay"></canvas>
      <div class="wash" aria-hidden="true"></div>
    </section>
  </div>

  <canvas id="capture" style="display:none;"></canvas>

<script>
  // =========================
  // CONFIG
  // =========================
  // const DJANGO_URL = "http://localhost:8000/hand_recognition/";
  const DJANGO_URL = "https://gentle-conferences-employed-graduation.trycloudflare.com/hand_landmarks/";
  const AUTH_TOKEN = "";

  const RATE = {
    normal: { interval: 220, jpeg: 0.72 },
    fast:   { interval: 150, jpeg: 0.74 },
    battery:{ interval: 420, jpeg: 0.70 },
    pause:  { interval: 999999, jpeg: 0.76 },
  };

  const FINGERTIPS = [
    { name:"THUMB",  id: 4,  emoji:"üëç" },
    { name:"INDEX",  id: 8,  emoji:"‚òùÔ∏è" },
    { name:"MIDDLE", id: 12, emoji:"‚Ä¢" },
    { name:"RING",   id: 16, emoji:"‚Ä¢" },
    { name:"PINKY",  id: 20, emoji:"‚Ä¢" },
  ];
  const TIP_BY_ID = Object.fromEntries(FINGERTIPS.map(t => [t.id, t]));

  const HAND_CONNECTIONS = [
    [0,1],[1,2],[2,3],[3,4],
    [0,5],[5,6],[6,7],[7,8],
    [5,9],[9,10],[10,11],[11,12],
    [9,13],[13,14],[14,15],[15,16],
    [13,17],[17,18],[18,19],[19,20],
    [0,17]
  ];

  // =========================
  // DOM
  // =========================
  const sessionLine = document.getElementById("sessionLine");
  const sig = document.getElementById("sig");
  const statusText = document.getElementById("statusText");
  const modeTag = document.getElementById("modeTag");
  const rateTag = document.getElementById("rateTag");

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const debugBtn = document.getElementById("debugBtn");

  const camFront = document.getElementById("camFront");
  const camBack = document.getElementById("camBack");

  const mirrorToggle = document.getElementById("mirrorToggle");
  const lmToggle = document.getElementById("lmToggle");
  const lblToggle = document.getElementById("lblToggle");

  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const overlayCtx = overlay.getContext("2d");
  const capture = document.getElementById("capture");

  const detectedLine = document.getElementById("detectedLine");
  const handed = document.getElementById("handed");
  const latEl = document.getElementById("lat");
  const frameIdEl = document.getElementById("frameId");
  const jpegQ = document.getElementById("jpegQ");
  const rateOut = document.getElementById("rateOut");

  const viewport = document.getElementById("viewport");

  // Toast
  const toast = document.getElementById("toast");
  const toastBar = document.getElementById("toastBar");
  const toastT = document.getElementById("toastT");
  const toastP = document.getElementById("toastP");
  const toastHint = document.getElementById("toastHint");

  // =========================
  // STATE
  // =========================
  let stream = null;
  let running = false;
  let inflight = 0;

  let sessionId = "av_" + Math.random().toString(16).slice(2, 10);
  let frameId = 0;

  let timer = null;
  let currentRate = "normal";
  let jpegQuality = RATE[currentRate].jpeg;
  let paused = false;

  let facingMode = "user";
  let mirror = true;
  let showLandmarks = true;
  let showLabels = true;

  let debugEnabled = false;
  let lastHands = [];

  // =========================
  // Helpers
  // =========================
  function setStatus(mode, text){
    statusText.textContent = text;
    sig.className = "sig " + (mode || "");
    modeTag.textContent =
      mode === "ok"   ? "TRACK ‚Ä¢ ONLINE" :
      mode === "warn" ? "TRACK ‚Ä¢ SEEKING" :
      mode === "bad"  ? "TRACK ‚Ä¢ FAULT" :
                        "TRACK ‚Ä¢ READY";
  }

  function setProcessing(on){
    viewport.classList.toggle("processing", !!on);
  }

  let toastTimer = null;
  function toastMsg(kind, title, message, hint=""){
    toastT.textContent = title;
    toastP.textContent = message;
    toastHint.textContent = hint || " ";
    toastBar.className = "bar " + (kind || "");
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 1700);
  }

  function toastDebugOnly(kind, title, message, hint=""){
    if (!debugEnabled) return;
    toastMsg(kind, title, message, hint);
  }

  function setDebug(on){
    debugEnabled = !!on;
    toastMsg(debugEnabled ? "ok" : "warn", "NAV-OPS", debugEnabled ? "Debug enabled." : "Debug disabled.");
  }

  function setDock(hands){
    if (!hands || hands.length === 0){
      detectedLine.textContent = "No hands detected";
      handed.textContent = "‚Äî";
      return;
    }
    const h0 = hands[0];
    const name = h0?.handedness?.name || "Hand";
    const score = h0?.handedness?.score ?? 0;

    handed.textContent = `${name} ${Math.round(score*100)}%`;

    const tips = (h0.fingertips || []).slice(0,5).map(t => {
      const meta = TIP_BY_ID[t.id] || {};
      return `${meta.emoji || "‚Ä¢"} ${t.name}`;
    });
    detectedLine.textContent = tips.length ? tips.join(" ‚Ä¢ ") : "Landmarks locked";
  }

  function setRate(rateKey){
    currentRate = rateKey;
    const cfg = RATE[currentRate] || RATE.normal;
    paused = (currentRate === "pause");
    jpegQuality = cfg.jpeg;

    jpegQ.textContent = jpegQuality.toFixed(2);
    rateOut.textContent = currentRate;
    rateTag.textContent = currentRate.toUpperCase();

    document.querySelectorAll('[data-rate]').forEach(b => {
      b.classList.toggle("active", b.dataset.rate === currentRate);
    });

    if (running){
      clearInterval(timer);
      timer = setInterval(tick, cfg.interval);
    }
    toastMsg("ok", "NAV-OPS", `Rate set: ${currentRate.toUpperCase()}`);
  }

  function setToggle(el, on){
    el.classList.toggle("on", !!on);
    el.setAttribute("aria-checked", on ? "true" : "false");
  }

  function resizeOverlay(){
    const rect = video.getBoundingClientRect();
    overlay.width = Math.max(1, Math.round(rect.width * devicePixelRatio));
    overlay.height = Math.max(1, Math.round(rect.height * devicePixelRatio));
  }
  window.addEventListener("resize", resizeOverlay);

  // =========================
  // Camera
  // =========================
  async function startCamera(){
    if (!navigator?.mediaDevices?.getUserMedia){
      alert("Camera API unavailable. Use HTTPS or localhost and allow camera permission.");
      throw new Error("getUserMedia unavailable");
    }

    await stopCamera();

    const constraints = {
      video: { facingMode: facingMode, width: { ideal: 720 }, height: { ideal: 540 } },
      audio: false
    };

    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (err){
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    }

    video.srcObject = stream;
    await video.play();

    video.style.transform = mirror ? "scaleX(-1)" : "none";
    requestAnimationFrame(resizeOverlay);
  }

  async function stopCamera(){
    if (stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }

  function captureBase64(){
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) return null;

    capture.width = w;
    capture.height = h;
    const ctx = capture.getContext("2d");

    if (mirror){
      ctx.save();
      ctx.translate(w, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, w, h);
      ctx.restore();
    } else {
      ctx.drawImage(video, 0, 0, w, h);
    }

    const dataUrl = capture.toDataURL("image/jpeg", jpegQuality);
    return { b64: (dataUrl.split(",")[1] || ""), w, h };
  }

  // =========================
  // Network
  // =========================
  async function post(payload){
    const headers = { "Content-Type": "application/json" };
    if (AUTH_TOKEN) headers["Authorization"] = "Bearer " + AUTH_TOKEN;

    const res = await fetch(DJANGO_URL, { method:"POST", headers, body: JSON.stringify(payload) });
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch {}

    if (!res.ok){
      const msg = data?.error?.message || txt || `HTTP ${res.status}`;
      const code = data?.error?.code || "HTTP_ERROR";
      return { ok:false, error:{ code, message: msg }, _http: res.status };
    }
    return data;
  }

  // =========================
  // Drawing
  // =========================
  function clearOverlay(){
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  }

  function drawHands(hands){
    clearOverlay();
    if (!showLandmarks || !hands?.length) return;

    const W = overlay.width, H = overlay.height;

    for (const hand of hands){
      const lms = hand.landmarks || [];
      if (lms.length < 21) continue;

      // Connections (cobalt)
      overlayCtx.save();
      overlayCtx.lineWidth = Math.max(2, Math.round(2 * devicePixelRatio));
      overlayCtx.lineCap = "round";
      overlayCtx.lineJoin = "round";
      overlayCtx.strokeStyle = "rgba(62,124,255,0.92)";
      overlayCtx.shadowColor = "rgba(62,124,255,0.16)";
      overlayCtx.shadowBlur = 14 * devicePixelRatio;

      overlayCtx.beginPath();
      for (const [a,b] of HAND_CONNECTIONS){
        const A = lms[a], B = lms[b];
        if (!A || !B) continue;
        overlayCtx.moveTo(A.x * W, A.y * H);
        overlayCtx.lineTo(B.x * W, B.y * H);
      }
      overlayCtx.stroke();
      overlayCtx.restore();

      // Dots (copper)
      overlayCtx.save();
      overlayCtx.fillStyle = "rgba(214,119,64,0.92)";
      overlayCtx.shadowColor = "rgba(214,119,64,0.14)";
      overlayCtx.shadowBlur = 12 * devicePixelRatio;

      const r = 3.0 * devicePixelRatio;
      for (const lm of lms){
        overlayCtx.beginPath();
        overlayCtx.arc(lm.x * W, lm.y * H, r, 0, Math.PI * 2);
        overlayCtx.fill();
      }
      overlayCtx.restore();

      // Labels (ink)
      if (showLabels){
        overlayCtx.save();
        overlayCtx.font = `${Math.round(12*devicePixelRatio)}px ${getComputedStyle(document.body).fontFamily}`;
        overlayCtx.fillStyle = "rgba(11,14,20,0.86)";
        overlayCtx.strokeStyle = "rgba(255,255,255,0.75)";
        overlayCtx.lineWidth = 4 * devicePixelRatio;

        for (const t of (hand.fingertips || [])){
          const meta = TIP_BY_ID[t.id] || {};
          const label = `${meta.emoji || "‚Ä¢"} ${t.name}`;
          const x = (t.x ?? 0) * W;
          const y = (t.y ?? 0) * H;
          overlayCtx.strokeText(label, x + 10*devicePixelRatio, y - 10*devicePixelRatio);
          overlayCtx.fillText(label, x + 10*devicePixelRatio, y - 10*devicePixelRatio);
        }
        overlayCtx.restore();
      }
    }
  }

  // =========================
  // Loop
  // =========================
  async function tick(){
    if (!running || inflight >= 1 || paused) return;

    inflight++;
    setProcessing(true);

    const localFrameId = ++frameId;
    frameIdEl.textContent = String(localFrameId);

    const t0 = performance.now();
    try{
      const snap = captureBase64();
      if (!snap) return;

      const payload = {
        session_id: sessionId,
        frame_id: localFrameId,
        ts_client_ms: Date.now(),
        image: { format: "jpeg", data_b64: snap.b64 },
        telemetry: {
          width: snap.w,
          height: snap.h,
          camera: facingMode,
          mirror: mirror,
          quality: jpegQuality,
          overlays: { landmarks: showLandmarks, labels: showLabels }
        }
      };

      const data = await post(payload);

      const t1 = performance.now();
      const rtt = Math.round(t1 - t0);
      latEl.textContent = ((data?.latency_ms ?? rtt) + "ms");

      if (!data || data.ok !== true){
        setStatus("bad", "FAULT");
        toastDebugOnly("bad","NAV-OPS fault",
          (data?.error?.code || "SERVER_FAULT") + " ‚Äî " + (data?.error?.message || "Unknown"),
          `frame ${localFrameId}`
        );
        lastHands = [];
        drawHands(lastHands);
        setDock(lastHands);
        return;
      }

      lastHands = Array.isArray(data.hands) ? data.hands : [];
      drawHands(lastHands);
      setDock(lastHands);

      if (lastHands.length){
        setStatus("ok", "TRACKING");
      } else {
        setStatus("warn", "SEEKING");
      }

    } catch (e){
      setStatus("bad", "FAULT");
      toastDebugOnly("bad","NAV-OPS fault", e?.message || String(e), `frame ${localFrameId}`);
    } finally {
      inflight = Math.max(0, inflight - 1);
      setProcessing(false);
    }
  }

  function startLoop(){
    clearInterval(timer);
    timer = setInterval(tick, RATE[currentRate].interval);
  }

  function stopLoop(){
    running = false;
    clearInterval(timer);
    timer = null;
    inflight = 0;

    setStatus("", "STANDBY");
    setProcessing(false);

    lastHands = [];
    drawHands(lastHands);
    setDock(lastHands);

    frameIdEl.textContent = "‚Äî";
    latEl.textContent = "‚Äî";
  }

  // =========================
  // UI events
  // =========================
  document.querySelectorAll('[data-rate]').forEach(btn => {
    btn.addEventListener("click", () => setRate(btn.dataset.rate));
  });

  function setFacing(mode){
    facingMode = mode;
    camFront.classList.toggle("active", facingMode === "user");
    camBack.classList.toggle("active", facingMode === "environment");
    toastMsg("warn", "NAV-OPS", "Switching camera‚Ä¶");
  }

  async function restartCamera(){
    if (!running) return;
    await stopCamera();
    await startCamera();
    toastMsg("ok", "NAV-OPS", `Camera: ${facingMode === "user" ? "Front" : "Back"}`);
  }

  camFront.addEventListener("click", async () => { setFacing("user"); await restartCamera(); });
  camBack.addEventListener("click", async () => { setFacing("environment"); await restartCamera(); });

  function toggleRow(el, get, set){
    const next = !get();
    set(next);
    el.classList.toggle("on", next);
    el.setAttribute("aria-checked", next ? "true" : "false");
    return next;
  }

  mirrorToggle.addEventListener("click", () => {
    const v = toggleRow(mirrorToggle, () => mirror, x => mirror = x);
    video.style.transform = v ? "scaleX(-1)" : "none";
    toastMsg("ok", "NAV-OPS", `Mirror: ${v ? "ON" : "OFF"}`);
  });

  lmToggle.addEventListener("click", () => {
    const v = toggleRow(lmToggle, () => showLandmarks, x => showLandmarks = x);
    toastMsg("ok", "NAV-OPS", `Landmarks: ${v ? "ON" : "OFF"}`);
    drawHands(lastHands);
  });

  lblToggle.addEventListener("click", () => {
    const v = toggleRow(lblToggle, () => showLabels, x => showLabels = x);
    toastMsg("ok", "NAV-OPS", `Labels: ${v ? "ON" : "OFF"}`);
    drawHands(lastHands);
  });

  [mirrorToggle,lmToggle,lblToggle].forEach(el => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); el.click(); }
    });
  });

  debugBtn.addEventListener("click", () => {
    if (debugEnabled){ setDebug(false); return; }
    const pw = prompt("Enter debug password:");
    if (pw === "cisco") setDebug(true);
    else toastMsg("bad","NAV-OPS","Incorrect password.");
  });

  startBtn.addEventListener("click", async () => {
    try{
      startBtn.disabled = true;
      setStatus("warn","STARTING");
      toastMsg("warn","NAV-OPS","Requesting camera access‚Ä¶");

      await startCamera();

      running = true;
      stopBtn.disabled = false;

      setRate(currentRate);
      startLoop();

      setStatus("ok","ONLINE");
      toastMsg("ok","NAV-OPS","Online. Landmark tracking active.");
    } catch (e){
      setStatus("bad","FAULT");
      toastDebugOnly("bad","NAV-OPS fault", e?.message || String(e), "startup");
      if (!debugEnabled) toastMsg("bad","NAV-OPS","Camera start failed.","Enable Debug for details");
    } finally {
      startBtn.disabled = false;
    }
  });

  stopBtn.addEventListener("click", async () => {
    stopLoop();
    await stopCamera();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    toastMsg("warn","NAV-OPS","Camera offline.");
  });

  // =========================
  // Init
  // =========================
  sessionLine.textContent = `session: ${sessionId}`;
  setStatus("", "STANDBY");

  // rate default
  setRate("normal");
  setDock([]);

  toastMsg("", "NAV-OPS", "Ready. Camera On to begin.");
</script>
</body>
</html>
